# 🏗️ Tiny Agent 部署架构

## 🌐 系统架构图

### 完整生产环境架构

```
                        ┌─────────────────────┐
                        │    用户浏览器         │
                        └──────────┬──────────┘
                                   │ HTTP/HTTPS
                                   │
                        ┌──────────▼──────────┐
                        │   Nginx (Port 80)   │
                        │   - 反向代理          │
                        │   - 静态文件服务      │
                        │   - SSL 终止          │
                        │   - 负载均衡          │
                        └──────────┬──────────┘
                                   │ HTTP
                                   │
              ┌────────────────────┴────────────────────┐
              │                                         │
    ┌─────────▼─────────┐                    ┌─────────▼─────────┐
    │  Gunicorn Worker 1 │                    │  Gunicorn Worker 2 │
    │   Flask App        │                    │   Flask App        │
    └─────────┬─────────┘                    └─────────┬─────────┘
              │                                         │
              └────────────────────┬────────────────────┘
                                   │
                        ┌──────────▼──────────┐
                        │   数据层              │
                        │  - SQLite (data/)   │
                        │  - 上传文件 (data/)  │
                        │  - 日志 (logs/)      │
                        └─────────────────────┘
```

### Docker 容器架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Docker Host                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────────────────────────────────────────┐    │
│  │  tiny_agent_network (Bridge Network)              │    │
│  │                                                     │    │
│  │  ┌─────────────────────┐  ┌─────────────────────┐ │    │
│  │  │  nginx 容器          │  │  tiny_agent 容器    │ │    │
│  │  │  Port: 80/443       │  │  Port: 5000        │ │    │
│  │  │  Image: nginx:alpine│  │  Image: tiny_agent │ │    │
│  │  └─────────────────────┘  └──────────┬──────────┘ │    │
│  │                                       │            │    │
│  └───────────────────────────────────────┼────────────┘    │
│                                          │                 │
│  ┌───────────────────────────────────────▼──────────────┐  │
│  │  Volume Mounts                                       │  │
│  │  - data/     → /app/data     (读写)                 │  │
│  │  - logs/     → /app/logs     (读写)                 │  │
│  │  - .env      → /app/.env     (只读)                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 📊 数据流图

### 用户请求流程

```
用户浏览器
    │
    │ 1. HTTP Request
    ▼
Nginx (Port 80)
    │
    │ 2. Proxy Pass
    ▼
Gunicorn (Port 5000)
    │
    │ 3. WSGI
    ▼
Flask Application
    │
    ├─────► 4a. 认证路由 (/auth)
    │       └─► SQLite (验证用户)
    │
    ├─────► 4b. 文件路由 (/files)
    │       └─► File System (读写文件)
    │
    ├─────► 4c. 命令路由 (/commands)
    │       └─► Subprocess (执行命令)
    │
    └─────► 4d. 日志路由 (/logs)
            └─► Log Files (读取日志)
    │
    │ 5. JSON Response
    ▼
用户浏览器
```

### 文件上传流程

```
[用户选择文件] → [浏览器 FormData]
                      │
                      │ POST /files/upload
                      ▼
                  [Flask Routes]
                      │
                      ├─ 1. 验证文件类型
                      ├─ 2. 检查文件大小
                      ├─ 3. 安全文件名处理
                      ├─ 4. 保存到 data/uploads/
                      └─ 5. (可选) AI 处理
                      │
                      │ JSON Response
                      ▼
              [浏览器显示结果]
```

## 🔄 部署模式对比

### 模式 1: 完整生产环境

```
┌──────────────────────────────────────────┐
│  Docker Compose (docker-compose.yml)    │
├──────────────────────────────────────────┤
│                                          │
│  ┌────────────┐      ┌────────────┐    │
│  │   Nginx    │ ───► │ Tiny Agent │    │
│  │  (Port 80) │      │ (Gunicorn) │    │
│  └────────────┘      └────────────┘    │
│                                          │
│  特点:                                   │
│  ✓ 高性能                                │
│  ✓ 静态文件缓存                           │
│  ✓ SSL 支持                              │
│  ✓ 负载均衡                              │
└──────────────────────────────────────────┘
```

### 模式 2: 精简生产环境

```
┌──────────────────────────────────────────┐
│  Docker Compose (docker-compose.yml)    │
├──────────────────────────────────────────┤
│                                          │
│         ┌────────────┐                  │
│         │ Tiny Agent │                  │
│         │ (Gunicorn) │                  │
│         │ (Port 5000)│                  │
│         └────────────┘                  │
│                                          │
│  特点:                                   │
│  ✓ 资源占用少                            │
│  ✓ 配置简单                              │
│  ✓ 适合已有代理                          │
└──────────────────────────────────────────┘
```

### 模式 3: 开发环境

```
┌──────────────────────────────────────────┐
│  Docker Compose (docker-compose.dev.yml)│
├──────────────────────────────────────────┤
│                                          │
│         ┌────────────┐                  │
│         │ Tiny Agent │                  │
│         │   (Flask)  │ ← 代码挂载       │
│         │ (Port 5000)│   (热重载)       │
│         └────────────┘                  │
│                                          │
│  特点:                                   │
│  ✓ 代码热重载                            │
│  ✓ 详细错误信息                          │
│  ✓ 便于调试                              │
└──────────────────────────────────────────┘
```

## 🗂️ 目录映射关系

### 宿主机 → 容器

```
tiny_agent/                    /app/
├── backend/         ────►     └── backend/
├── frontend/        ────►     └── frontend/
├── data/            ────►     └── data/        (Volume)
│   ├── app.db                 │   └── app.db
│   └── uploads/               │   └── uploads/
├── logs/            ────►     └── logs/        (Volume)
│   └── system.log             │   └── system.log
└── .env             ────►     └── .env         (Volume)
```

## 🔐 安全层级

```
┌─────────────────────────────────────────┐
│  Layer 1: 网络安全                      │
│  - 防火墙规则                           │
│  - SSL/TLS 加密                         │
│  - DDoS 防护                            │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Layer 2: 应用安全                      │
│  - 用户认证 (Flask-Login)               │
│  - 角色授权 (Admin/User)                │
│  - 密码加密 (Werkzeug)                  │
│  - Session 管理                         │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Layer 3: 数据安全                      │
│  - 文件类型验证                         │
│  - 文件大小限制                         │
│  - 安全文件名处理                       │
│  - 命令白名单                           │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Layer 4: 容器隔离                      │
│  - Docker 命名空间                      │
│  - 资源限制                             │
│  - 只读文件系统                         │
│  - 非 root 用户                         │
└─────────────────────────────────────────┘
```

## 📈 性能优化层次

### 应用层优化

```
┌──────────────────────────────┐
│  1. Gunicorn 多进程           │
│     Workers = CPU × 2 + 1    │
└──────────┬───────────────────┘
           │
┌──────────▼───────────────────┐
│  2. Flask 应用优化            │
│     - 路由缓存                │
│     - 数据库连接池            │
│     - 静态文件 CDN            │
└──────────┬───────────────────┘
           │
┌──────────▼───────────────────┐
│  3. 数据库优化                │
│     - 索引优化                │
│     - 查询优化                │
│     - 连接池                  │
└──────────────────────────────┘
```

### 网络层优化

```
┌──────────────────────────────┐
│  1. Nginx 缓存                │
│     - 静态文件缓存            │
│     - Gzip 压缩               │
└──────────┬───────────────────┘
           │
┌──────────▼───────────────────┐
│  2. HTTP/2                    │
│     - 多路复用                │
│     - 头部压缩                │
└──────────┬───────────────────┘
           │
┌──────────▼───────────────────┐
│  3. CDN                       │
│     - 静态资源分发            │
│     - 就近访问                │
└──────────────────────────────┘
```

## 🔄 扩展方案

### 水平扩展（多实例）

```
                    ┌─────────────┐
                    │ Load Balancer│
                    └──────┬───────┘
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
    ┌────▼────┐       ┌────▼────┐      ┌────▼────┐
    │Instance1│       │Instance2│      │Instance3│
    └────┬────┘       └────┬────┘      └────┬────┘
         │                 │                 │
         └─────────────────┼─────────────────┘
                           │
                    ┌──────▼───────┐
                    │ 共享存储      │
                    │ (NFS/S3)     │
                    └──────────────┘
```

### 垂直扩展（增强资源）

```
小型部署              中型部署              大型部署
──────────           ──────────           ──────────
CPU: 1-2 核          CPU: 4-8 核          CPU: 16+ 核
RAM: 512MB-1GB       RAM: 2-4GB           RAM: 8GB+
Workers: 2-4         Workers: 8-16        Workers: 32+
Disk: 5GB            Disk: 20GB           Disk: 100GB+
```

## 📊 监控架构

```
┌─────────────────────────────────────────┐
│           监控堆栈 (可选)                │
├─────────────────────────────────────────┤
│                                         │
│  ┌──────────────┐    ┌──────────────┐ │
│  │  Prometheus  │ ─► │   Grafana    │ │
│  │   (指标采集)  │    │   (可视化)   │ │
│  └──────┬───────┘    └──────────────┘ │
│         │                               │
│  ┌──────▼───────┐    ┌──────────────┐ │
│  │cAdvisor      │    │ AlertManager │ │
│  │(容器监控)     │    │   (告警)     │ │
│  └──────────────┘    └──────────────┘ │
│                                         │
└─────────────────────────────────────────┘
         │
         │ 采集指标
         ▼
┌─────────────────────────────────────────┐
│         Tiny Agent 容器                  │
└─────────────────────────────────────────┘
```

---

**说明**: 本文档提供了 Tiny Agent 的完整部署架构视图，帮助理解系统各组件的关系和数据流向。
